---
layout: default
title: Flights
permalink: /flights
---

<style>
  ::-webkit-scrollbar {
    width: 0 !important;
  }
</style>
<link href="/node_modules/mapbox-gl/dist/mapbox-gl.css" rel="stylesheet" />
<script src="/node_modules/mapbox-gl/dist/mapbox-gl.js"></script>
<div
  id="map"
  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%"
></div>
<script>
  mapboxgl.accessToken =
    "pk.eyJ1Ijoia292dXRoZWh1c2t5IiwiYSI6ImNqOG5mN3djYjE5czkycXJ0dzRnd3ZxMWoifQ.GzioSYbbeQRtheWUd-BVAw";
  const map = new mapboxgl.Map({
    attributionControl: false,
    center: [-74.0059662, 40.7127848],
    container: "map",
    hash: true,
    projection: "globe",
    style: "mapbox://styles/mapbox/dark-v11",
    zoom: 2,
  });
  map.dragRotate.disable();
  map.touchZoomRotate.disableRotation();
  map.addControl(
    new mapboxgl.AttributionControl({
      compact: true,
    }),
    "bottom-right",
  );

  async function loadFlightRoutesFromCSV(url) {
    try {
      const response = await fetch(url);
      const csvText = await response.text();

      const routes = [];
      const lines = csvText.trim().split("\n");
      const header = lines[0].split(",");
      const fromIndex = header.indexOf("From");
      const toIndex = header.indexOf("To");
      const canceledIndex = header.indexOf("Canceled");

      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(",");
        if (columns.length > Math.max(fromIndex, toIndex, canceledIndex)) {
          const from = columns[fromIndex]?.trim();
          const to = columns[toIndex]?.trim();
          const isCanceled = columns[canceledIndex] === "true";

          if (from && to && !isCanceled) {
            routes.push({ origin: from, destination: to });
          }
        }
      }
      return routes;
    } catch (error) {
      console.error("Error loading or parsing flight data:", error);
      return [];
    }
  }

  async function getAirportDatabase() {
    const response = await fetch("/airports.json");
    const airports = await response.json();
    return new Map(
      airports.map((airport) => [airport.code, [airport.lat, airport.lon]]),
    );
  }

  function createRouteFeatures(routes, db) {
    const features = [];
    for (const route of routes) {
      const originCoords = db.get(route.origin);
      const destCoords = db.get(route.destination);

      if (!originCoords || !destCoords) continue;

      const originLng = originCoords[0];
      let destLng = destCoords[0];

      const diff = destLng - originLng;
      if (diff > 180) {
        destLng -= 360;
      } else if (diff < -180) {
        destLng += 360;
      }

      const adjustedDestCoords = [destLng, destCoords[1]];

      features.push({
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: [originCoords, adjustedDestCoords],
        },
        properties: {
          origin: route.origin,
          destination: route.destination,
          count: route.count,
        },
      });
    }
    return features;
  }

  function createAirportFeatures(airportCounts, db) {
    const features = [];
    for (const [code, count] of airportCounts.entries()) {
      const coords = db.get(code);
      if (coords) {
        features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: coords },
          properties: {
            code: code,
            count: count,
          },
        });
      }
    }
    return features;
  }

  map.on("load", async () => {
    const [airportDb, flightRoutes] = await Promise.all([
      getAirportDatabase(),
      loadFlightRoutesFromCSV("/flights.csv"),
    ]);

    const routeStats = new Map();
    const airportStats = new Map();

    flightRoutes.forEach((route) => {
      const routeKey = [route.origin, route.destination].sort().join("-");
      if (!routeStats.has(routeKey)) {
        routeStats.set(routeKey, {
          origin: route.origin,
          destination: route.destination,
          count: 0,
        });
      }
      routeStats.get(routeKey).count++;

      airportStats.set(route.origin, (airportStats.get(route.origin) || 0) + 1);
      airportStats.set(
        route.destination,
        (airportStats.get(route.destination) || 0) + 1,
      );
    });

    const uniqueFlightRoutes = Array.from(routeStats.values());
    const routeFeatures = createRouteFeatures(uniqueFlightRoutes, airportDb);
    const airportFeatures = createAirportFeatures(airportStats, airportDb);

    map.addSource("flight-routes", {
      type: "geojson",
      data: { type: "FeatureCollection", features: routeFeatures },
    });

    map.addLayer({
      id: "route-lines",
      type: "line",
      source: "flight-routes",
      paint: {
        "line-color": "#5dde95",
        "line-opacity": 0.8,
        "line-width": [
          "interpolate",
          ["linear"],
          ["get", "count"],
          1,
          1,
          10,
          10,
        ],
      },
    });

    map.addSource("airport-nodes", {
      type: "geojson",
      data: { type: "FeatureCollection", features: airportFeatures },
    });

    map.addLayer({
      id: "airport-points",
      type: "circle",
      source: "airport-nodes",
      paint: {
        "circle-radius": 5,
        "circle-color": "#5dde95",
        "circle-stroke-color": "white",
        "circle-stroke-width": 1.25,
      },
    });
  });

  map.on("click", (e) => {
    const features = map.queryRenderedFeatures(e.point, {
      layers: ["airport-points", "route-lines"],
    });

    if (!features.length) return;

    const feature = features[0];

    if (feature.layer.id === "airport-points") {
      const props = feature.properties;
      const coordinates = feature.geometry.coordinates.slice();

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      const description = `
        <div class="text-center" style="color: #000;">
          <h6 class="mb-0">${props.code}</h6>
          <p class="m-0">${props.count} flights</p>
        </div>
      `;

      new mapboxgl.Popup({ closeButton: false })
        .setLngLat(coordinates)
        .setHTML(description)
        .addTo(map);
    } else if (feature.layer.id === "route-lines") {
      const props = feature.properties;
      const description = `
        <div class="text-center" style="color: #000;">
          <h6 class="mb-0">${props.origin} â†” ${props.destination}</h6>
          <p class="m-0">${props.count} flights</p>
        </div>
      `;

      new mapboxgl.Popup({ closeButton: false })
        .setLngLat(e.lngLat)
        .setHTML(description)
        .addTo(map);
    }
  });

  map.on("mouseenter", ["airport-points", "route-lines"], function () {
    map.getCanvas().style.cursor = "pointer";
  });

  map.on("mouseleave", ["airport-points", "route-lines"], function () {
    map.getCanvas().style.cursor = "";
  });
</script>
