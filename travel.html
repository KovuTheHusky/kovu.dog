---
layout: default
title: Travel
permalink: /travel
---

<style>
  ::-webkit-scrollbar {
    width: 0 !important;
  }
</style>
<link href="/node_modules/mapbox-gl/dist/mapbox-gl.css" rel="stylesheet" />
<script
  src="/node_modules/mapbox-gl/dist/mapbox-gl.js"
  data-cfasync="false"
></script>
<div
  id="map"
  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%"
></div>
<div class="position-absolute bottom-0 start-50 translate-middle-x mb-4 z-3">
  <div class="btn-group" role="group" aria-label="Layer Toggles">
    <input
      type="checkbox"
      class="btn-check"
      id="toggle-places"
      autocomplete="off"
      checked
    />
    <label class="btn btn-dark" for="toggle-places">Places</label>

    <input
      type="checkbox"
      class="btn-check"
      id="toggle-flights"
      autocomplete="off"
      checked
    />
    <label class="btn btn-dark" for="toggle-flights">Flights</label>
  </div>
</div>
<script data-cfasync="false">
  mapboxgl.accessToken =
    "pk.eyJ1Ijoia292dXRoZWh1c2t5IiwiYSI6ImNqOG5mN3djYjE5czkycXJ0dzRnd3ZxMWoifQ.GzioSYbbeQRtheWUd-BVAw";
  var map = new mapboxgl.Map({
    attributionControl: false,
    center: [-74.0059662, 40.7127848],
    container: "map",
    hash: true,
    projection: "globe",
    style: {
      version: 8,
      sources: {
        "mapbox-dark-tiles": {
          type: "raster",
          tiles: [
            `https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${mapboxgl.accessToken}`,
          ],
          tileSize: 256,
        },
      },
      sprite: "https://{{ site.hostname }}/sprite",
      glyphs: "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
      layers: [
        {
          id: "mapbox-dark-layer",
          type: "raster",
          source: "mapbox-dark-tiles",
        },
      ],
    },
    zoom: 2,
  });
  map.dragRotate.disable();
  map.touchZoomRotate.disableRotation();
  map.addControl(
    new mapboxgl.AttributionControl({ compact: true }),
    "bottom-right",
  );

  async function loadFlightRoutesFromCSV(url) {
    try {
      const response = await fetch(url);
      const csvText = await response.text();
      const routes = [];
      const lines = csvText.trim().split("\n");
      const header = lines[0].split(",");
      const fromIndex = header.indexOf("From");
      const toIndex = header.indexOf("To");
      const canceledIndex = header.indexOf("Canceled");

      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(",");
        if (columns.length > Math.max(fromIndex, toIndex, canceledIndex)) {
          const from = columns[fromIndex]?.trim();
          const to = columns[toIndex]?.trim();
          const isCanceled = columns[canceledIndex] === "true";
          if (from && to && !isCanceled) {
            routes.push({ origin: from, destination: to });
          }
        }
      }
      return routes;
    } catch (error) {
      console.error("Error loading flight data:", error);
      return [];
    }
  }

  async function getAirportDatabase() {
    const response = await fetch("/airports.json");
    const airports = await response.json();
    return new Map(
      airports.map((airport) => [airport.code, [airport.lat, airport.lon]]),
    );
  }

  function createRouteFeatures(routes, db) {
    const features = [];
    for (const route of routes) {
      const originCoords = db.get(route.origin);
      const destCoords = db.get(route.destination);
      if (!originCoords || !destCoords) continue;

      const originLng = originCoords[0];
      let destLng = destCoords[0];

      const diff = destLng - originLng;
      if (diff > 180) destLng -= 360;
      else if (diff < -180) destLng += 360;

      features.push({
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: [originCoords, [destLng, destCoords[1]]],
        },
        properties: {
          origin: route.origin,
          destination: route.destination,
          count: route.count,
        },
      });
    }
    return features;
  }

  function createAirportFeatures(airportCounts, db) {
    const features = [];
    for (const [code, count] of airportCounts.entries()) {
      const coords = db.get(code);
      if (coords) {
        features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: coords },
          properties: { code: code, count: count },
        });
      }
    }
    return features;
  }

  map.on("load", async function () {
    const [airportDb, flightRoutes] = await Promise.all([
      getAirportDatabase(),
      loadFlightRoutesFromCSV("/flights.csv"),
    ]);

    const routeStats = new Map();
    const airportStats = new Map();

    flightRoutes.forEach((route) => {
      const routeKey = [route.origin, route.destination].sort().join("-");
      if (!routeStats.has(routeKey)) {
        routeStats.set(routeKey, {
          origin: route.origin,
          destination: route.destination,
          count: 0,
        });
      }
      routeStats.get(routeKey).count++;
      airportStats.set(route.origin, (airportStats.get(route.origin) || 0) + 1);
      airportStats.set(
        route.destination,
        (airportStats.get(route.destination) || 0) + 1,
      );
    });

    const routeFeatures = createRouteFeatures(
      Array.from(routeStats.values()),
      airportDb,
    );
    const airportFeatures = createAirportFeatures(airportStats, airportDb);

    map.addSource("flight-routes", {
      type: "geojson",
      data: { type: "FeatureCollection", features: routeFeatures },
    });
    map.addSource("airport-nodes", {
      type: "geojson",
      data: { type: "FeatureCollection", features: airportFeatures },
    });

    map.addLayer({
      id: "route-lines",
      type: "line",
      source: "flight-routes",
      paint: {
        "line-color": "#76e9c8",
        "line-opacity": 1,
        "line-width": [
          "interpolate",
          ["linear"],
          ["get", "count"],
          1,
          1,
          10,
          10,
        ],
      },
    });

    map.addLayer({
      id: "airport-points",
      type: "circle",
      source: "airport-nodes",
      paint: {
        "circle-radius": 5,
        "circle-color": "#76e9c8",
        "circle-stroke-color": "white",
        "circle-stroke-width": 1.25,
      },
    });

    map.addSource("places", {
      type: "geojson",
      data: "https://status.{{ site.hostname }}/places.geojson",
    });

    map.addLayer({
      id: "places-dots",
      type: "circle",
      source: "places",
      maxzoom: 12,
      paint: {
        "circle-radius": 2.5,
        "circle-color": "#44d262",
        "circle-stroke-width": 0,
      },
    });

    map.addLayer({
      id: "places-icons",
      type: "symbol",
      source: "places",
      minzoom: 10,
      layout: {
        "icon-image": ["get", "icon"],
        "icon-size": [
          "interpolate",
          ["linear"],
          ["zoom"],
          10,
          0.08,
          11,
          0.25,
          12,
          0.5,
        ],
        "icon-allow-overlap": true,
        "icon-ignore-placement": true,
      },
    });
  });

  const interactiveLayers = [
    "places-dots",
    "places-icons",
    "airport-points",
    "route-lines",
  ];

  map.on("click", interactiveLayers, function (e) {
    const feature = e.features[0];
    const layerId = feature.layer.id;
    let html = "";
    let coordinates = e.lngLat;

    if (layerId === "places-dots" || layerId === "places-icons") {
      // --- Places Popup ---
      coordinates = feature.geometry.coordinates;
      html = '<div class="text-center" style="color: #000;">';
      html += '<h6 class="mb-1">' + feature.properties.name + "</h6>";

      if (
        feature.properties.address &&
        feature.properties.name != feature.properties.address
      ) {
        html +=
          '<p class="mb-1" style="line-height: 1.25em;">' +
          JSON.parse(feature.properties.address).join("<br>") +
          "</p>";
      }

      if (feature.properties.id) {
        html +=
          ' <a href="https://foursquare.com/v/' +
          feature.properties.id +
          '" class="rounded-circle" style="width: 40px; height: 40px; padding-top: 10px; display:inline-block; vertical-align:top; text-align:center; background-color: #ffa633;"><img src="/node_modules/simple-icons/icons/swarm.svg" style="filter: invert(1); width: 20px; height: 20px; vertical-align: top;"></a>';
      }

      html +=
        ' <a href="https://maps.apple.com/?sll=' +
        coordinates[1] +
        "," +
        coordinates[0] +
        "&q=" +
        feature.properties.name +
        '" class="rounded-circle" style="width: 40px; height: 40px; padding-top: 10px; display:inline-block; vertical-align:top; text-align:center; background-color: #999999;"><img src="/node_modules/simple-icons/icons/apple.svg" style="filter: invert(1); width: 20px; height: 20px; vertical-align: top;"></a> ';

      html +=
        ' <a href="https://www.google.com/maps/search/?api=1&query=' +
        coordinates[1] +
        "," +
        coordinates[0] +
        '" class="rounded-circle" style="width: 40px; height: 40px; padding-top: 10px; display:inline-block; vertical-align:top; text-align:center; background-color: #4285f4;"><img src="/node_modules/simple-icons/icons/googlemaps.svg" style="filter: invert(1); width: 20px; height: 20px; vertical-align: top;"></a> ';

      html += "</div>";
    } else if (layerId === "airport-points") {
      // --- Airport Popup ---
      coordinates = feature.geometry.coordinates.slice();
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      html = `
        <div class="text-center" style="color: #000;">
          <h6 class="mb-0">${feature.properties.code}</h6>
          <p class="m-0">${feature.properties.count} flights</p>
        </div>`;
    } else if (layerId === "route-lines") {
      // --- Route Popup ---
      html = `
        <div class="text-center" style="color: #000;">
          <h6 class="mb-0">${feature.properties.origin} â†” ${feature.properties.destination}</h6>
          <p class="m-0">${feature.properties.count} flights</p>
        </div>`;
    }

    new mapboxgl.Popup({ closeButton: false })
      .setLngLat(coordinates)
      .setHTML(html)
      .addTo(map);
  });

  map.on("mouseenter", interactiveLayers, function () {
    map.getCanvas().style.cursor = "pointer";
  });

  map.on("mouseleave", interactiveLayers, function () {
    map.getCanvas().style.cursor = "";
  });

  document.getElementById("toggle-places").addEventListener("change", (e) => {
    const visibility = e.target.checked ? "visible" : "none";
    if (map.getLayer("places-dots"))
      map.setLayoutProperty("places-dots", "visibility", visibility);
    if (map.getLayer("places-icons"))
      map.setLayoutProperty("places-icons", "visibility", visibility);
  });

  document.getElementById("toggle-flights").addEventListener("change", (e) => {
    const visibility = e.target.checked ? "visible" : "none";
    if (map.getLayer("route-lines"))
      map.setLayoutProperty("route-lines", "visibility", visibility);
    if (map.getLayer("airport-points"))
      map.setLayoutProperty("airport-points", "visibility", visibility);
  });
</script>
